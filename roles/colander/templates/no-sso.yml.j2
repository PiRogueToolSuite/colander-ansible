# {{ ansible_managed }}

volumes:
  production_traefik: {}
  production_traefik_logs: {}
  production_colander_postgres_data: {}
  production_colander_postgres_data_backups: {}
  production_threatr_postgres_data: {}
  production_threatr_postgres_data_backups: {}
  production_colander_minio_data: {}
  production_colander_es_data: {}
  dummy:
    driver: local
    driver_opts:
      type: none
      device: {{ docker_volumes_path }}/dummy
      o: bind

networks:
  frontend:
  backend:
    driver: bridge

services:
  # Databases
  colander-postgres:
    build:
      context: .
      dockerfile: ./compose/postgres/Dockerfile
    restart: unless-stopped
    logging:
      driver: journald
      options:
        labels: colander.service.name,colander.service.type
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - backend
    volumes:
      - production_colander_postgres_data:/var/lib/postgresql/data:Z
      - production_colander_postgres_data_backups:/backups:z
    env_file:
      - {{ dot_env_files_dir }}/{{ stack.services.colander_postgres.dot_env_file}}
    labels:
      colander.service.name: colander-postgres
      colander.service.type: database

  threatr-postgres:
    build:
      context: .
      dockerfile: ./compose/postgres/Dockerfile
    restart: unless-stopped
    logging:
      driver: journald
      options:
        labels: colander.service.name,colander.service.type
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready" ]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - backend
    volumes:
      - production_threatr_postgres_data:/var/lib/postgresql/data:Z
      - production_threatr_postgres_data_backups:/backups:z
    env_file:
      - {{ dot_env_files_dir }}/{{ stack.services.threatr_postgres.dot_env_file}}
    labels:
      colander.service.name: threatr-postgres
      colander.service.type: database

  colander-front:
    image: ghcr.io/piroguetoolsuite/colander:{{stack.services.colander.version}}
    restart: unless-stopped
    logging:
      driver: journald
      options:
        labels: colander.service.name,colander.service.type
    networks:
      - backend
    depends_on:
      colander-postgres:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      minio:
        condition: service_healthy
      redis:
        condition: service_healthy
      playwright:
        condition: service_started
      cyberchef:
        condition: service_started
    command: /start
    env_file:
      - {{ dot_env_files_dir }}/{{ stack.base.dot_env_file}}
      - {{ dot_env_files_dir }}/{{ stack.services.minio.dot_env_file}}
      - {{ dot_env_files_dir }}/{{ stack.services.colander.dot_env_file}}
      - {{ dot_env_files_dir }}/{{ stack.services.colander_postgres.dot_env_file}}
    labels:
      com.centurylinklabs.watchtower.enable: true
      colander.service.name: colander-front
      colander.service.type: web

  colander-worker:
    image: ghcr.io/piroguetoolsuite/colander:{{stack.services.colander.version}}
    restart: unless-stopped
    logging:
      driver: journald
      options:
        labels: colander.service.name,colander.service.type
    networks:
      - backend
    depends_on:
      colander-postgres:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      minio:
        condition: service_healthy
      redis:
        condition: service_healthy
      playwright:
        condition: service_started
    command: /start-worker
    env_file:
      - {{ dot_env_files_dir }}/{{ stack.base.dot_env_file}}
      - {{ dot_env_files_dir }}/{{ stack.services.minio.dot_env_file}}
      - {{ dot_env_files_dir }}/{{ stack.services.colander.dot_env_file}}
      - {{ dot_env_files_dir }}/{{ stack.services.colander_postgres.dot_env_file}}
    labels:
      com.centurylinklabs.watchtower.enable: true
      colander.service.name: colander-worker
      colander.service.type: worker

  threatr-front:
    image: ghcr.io/piroguetoolsuite/threatr:{{stack.services.threatr.version}}
    restart: unless-stopped
    logging:
      driver: journald
      options:
        labels: colander.service.name,colander.service.type
    networks:
      - backend
    depends_on:
      threatr-postgres:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: /start
    env_file:
      - {{ dot_env_files_dir }}/{{ stack.base.dot_env_file}}
      - {{ dot_env_files_dir }}/{{ stack.services.threatr.dot_env_file}}
      - {{ dot_env_files_dir }}/{{ stack.services.threatr_postgres.dot_env_file}}
    labels:
      com.centurylinklabs.watchtower.enable: true
      colander.service.name: threatr-front
      colander.service.type: web

  threatr-worker:
    image: ghcr.io/piroguetoolsuite/threatr:{{stack.services.threatr.version}}
    restart: unless-stopped
    logging:
      driver: journald
      options:
        labels: colander.service.name,colander.service.type
    networks:
      - backend
    depends_on:
      threatr-postgres:
        condition: service_healthy
      elasticsearch:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: /start-worker
    env_file:
      - {{ dot_env_files_dir }}/{{ stack.base.dot_env_file}}
      - {{ dot_env_files_dir }}/{{ stack.services.threatr.dot_env_file}}
      - {{ dot_env_files_dir }}/{{ stack.services.threatr_postgres.dot_env_file}}
    labels:
      com.centurylinklabs.watchtower.enable: true
      colander.service.name: threatr-worker
      colander.service.type: worker

  traefik:
    build:
      context: .
      dockerfile: ./compose/traefik/Dockerfile
    restart: unless-stopped
    logging:
      driver: journald
      options:
        labels: colander.service.name,colander.service.type
    networks:
      - frontend
      - backend
    depends_on:
      - colander-front
      - threatr-front
      - cyberchef
    volumes:
      - production_traefik:/etc/traefik/acme:z
      - production_traefik_logs:/logs/:z
    ports:
      - "0.0.0.0:80:80"
      - "0.0.0.0:443:443"
    labels:
      colander.service.name: traefik
      colander.service.type: proxy

  cyberchef:
    image: mpepping/cyberchef:{{stack.services.cyberchef.version}}
    restart: unless-stopped
    logging:
      driver: journald
      options:
        labels: colander.service.name,colander.service.type
    networks:
      - backend
    labels:
      com.centurylinklabs.watchtower.enable: false
      colander.service.name: cyberchef
      colander.service.type: web

  playwright:
    image: ghcr.io/piroguetoolsuite/playwright-rest-api:{{stack.services.playwright.version}}
    container_name: colander_production_playwright
    restart: unless-stopped
    logging:
      driver: journald
      options:
        labels: colander.service.name,colander.service.type
    networks:
      - backend
    labels:
      com.centurylinklabs.watchtower.enable: true
      colander.service.name: playwright
      colander.service.type: backend

  elasticsearch:
    image: elasticsearch:{{stack.services.elasticsearch.version}}
    restart: unless-stopped
    logging:
      driver: journald
      options:
        labels: colander.service.name,colander.service.type
    networks:
      - backend
    volumes:
      - production_colander_es_data:/usr/share/elasticsearch/data
    healthcheck:
      test: [ "CMD-SHELL", "curl -s -X GET http://localhost:9200/_cluster/health?pretty | grep status | grep -q '\\(green\\|yellow\\)'" ]
      interval: 10s
      timeout: 10s
      retries: 24
    environment:
      - discovery.type=single-node
      - xpack.security.enabled=false
      - path.repo=/usr/share/elasticsearch/data/snapshots
      - ES_JAVA_OPTS=-Xms{{stack.services.elasticsearch.xms}} -Xmx{{stack.services.elasticsearch.xmx}}
    labels:
      colander.service.name: elasticsearch
      colander.service.type: database

  minio:
    image: quay.io/minio/minio:{{stack.services.minio.version}}
    volumes:
      - production_colander_minio_data:/data
    command: server /data
    restart: unless-stopped
    logging:
      driver: journald
      options:
        labels: colander.service.name,colander.service.type
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:9000/minio/health/live" ]
      interval: 30s
      timeout: 20s
      retries: 3
    networks:
      - backend
    env_file:
      - {{ dot_env_files_dir }}/{{ stack.services.minio.dot_env_file}}
    labels:
      colander.service.name: minio
      colander.service.type: storage

  watchtower:
    image: containrrr/watchtower:{{stack.services.watchtower.version}}
    restart: unless-stopped
    logging:
      driver: journald
      options:
        labels: colander.service.name,colander.service.type
    networks:
      - backend
    volumes:
      - /etc/timezone:/etc/timezone:ro
      - {{docker_socket_path}}:/var/run/docker.sock:ro
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_LABEL_ENABLE=true
      - WATCHTOWER_INCLUDE_RESTARTING=true
      {{ stack.services.watchtower.environment | to_nice_yaml | indent(6) }}
    labels:
      com.centurylinklabs.watchtower.enable: true
      colander.service.name: watchtower
      colander.service.type: docker

  redis:
    image: redis:6
    restart: unless-stopped
    logging:
      driver: journald
      options:
        labels: colander.service.name,colander.service.type
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping | grep PONG"]
      interval: 2s
      timeout: 3s
      retries: 5
    networks:
      - backend
    labels:
      colander.service.name: redis
      colander.service.type: database
